
 RUN  v4.0.14 /mnt/C2B4A757B4A74CAB/code/poh-pwa
 ❯ tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts (4 tests | 3 failed) 20ms
     ✓ K1 output 1ms
     × K2 output 10ms
     × K3 output 7ms
     × K4 output 1ms
 ✓ tests/factories/TerraGenerator/helpers/post-processors/makeIsland.test.ts (3 tests) 2ms
 ✓ tests/helpers/arrayTools.test.ts (7 tests) 4ms
 ✓ tests/factories/TerraGenerator/helpers/post-processors/crawlTiles.test.ts (3 tests) 74ms
 ❯ tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts (3 tests | 3 failed) 78ms
     × marks all contiguous water tiles as salt 49ms
     × finds its way through a 5x5 'spiral maze' of water tiles 17ms
     × does not salt isolated water surrounded by land (3-ring 5x5) 11ms
 ✓ tests/factories/TerraGenerator/helpers/post-processors/river.test.ts (8 tests) 156ms
 ❯ tests/dataLoaders/gameDataLoader.test.ts (3 tests | 3 failed) 83ms
     × Throws on missing/invalid key/data 48ms
     × Build game objects and returns correct JSON, without optional 20ms
     × Build game objects and returns correct JSON, with optional 15ms
 ❯ tests/factories/TerrainMeshBuilder/hexTrianglesFromPoints.test.ts (8 tests | 3 failed) 15ms
     ✓ K1 output 1ms
     × K2 output 8ms
     × K3 output 2ms
     × K4 output 1ms
     ✓ K1 output 0ms
     ✓ K2 output 0ms
     ✓ K3 output 0ms
     ✓ K4 output 0ms
 ✓ tests/factories/TerraGenerator/helpers/mapTools.test.ts (1 test) 1ms
 ✓ tests/factories/TerraGenerator/helpers/post-processors/removeOrphanTerrain.test.ts (4 tests) 2ms
 ✓ tests/factories/TerraGenerator/helpers/post-processors/removeOrphanArea.test.ts (4 tests) 2ms
 ❯ tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts (9 tests | 5 failed) 12ms
     ✓ K1 output 1ms
     × K2 output 6ms
     × K3 output 1ms
     × K4 output 1ms
     × writes vertex data in point order and flattens RGBA/XYZ correctly (K1) 1ms
     × applies center offset (x,z) and inverts Z 0ms
     ✓ calls getColor/getHeight with correct argument triplets for center, corners, and edges (K2) 0ms
     ✓ offsets indices by existing vertex count when appending to a non-empty buffer 0ms
     ✓ does not mutate inputs and supports empty triangles/points 0ms
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Failed Tests 17 ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯
 FAIL  tests/dataLoaders/gameDataLoader.test.ts > gameDataLoader > Throws on missing/invalid key/data
AssertionError: expected [Function] to throw error including 'GameObject.key: \'player:1\', Attribu…' but got 'GameObject.key: \'player:1\', Attribu…'
Expected: "GameObject.key: 'player:1', Attribute: {"attrName":"cultureKey","attrNotRef":true,"related":{"theirKeyAttr":"playerKey","isOne":true}}, Message: Related object 'culture:1' does not exist. Raw data: {"key":"player:1","cultureKey":"culture:1","name":"test player","isCurrent":false}"
Received: "GameObject.key: 'player:1', Attribute: {"attrName":"cultureKey","attrNotRef":true,"related":{"theirKeyAttr":"playerKey","isOne":true}}, Message: Related object 'culture:1' does not exist. Raw data: {"key":"player:1","cultureKey":"culture:1","name":"test player","isCurrent":false,"isMinor":false}"
 ❯ tests/dataLoaders/gameDataLoader.test.ts:50:77
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/17]⎯
 FAIL  tests/dataLoaders/gameDataLoader.test.ts > gameDataLoader > Build game objects and returns correct JSON, without optional
AssertionError: expected { 'agenda:1': { …(2) }, …(11) } to deeply equal { 'agenda:1': { …(2) }, …(11) }
- Expected
+ Received
@@ -38,10 +38,11 @@
      "toPlayerKey": "player:1",
    },
    "player:1": {
      "cultureKey": "culture:1",
      "isCurrent": false,
+     "isMinor": false,
      "key": "player:1",
      "name": "test player",
    },
    "religion:1": {
      "cityKey": "city:1",
 ❯ tests/dataLoaders/gameDataLoader.test.ts:157:53
    155|
    156|     // output = input + defaults
    157|     expect(JSON.parse(JSON.stringify(gameObjects))).toEqual({
       |                                                     ^
    158|       "agenda:1": agendaData,
    159|       "citizen:1": citizenData,
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/17]⎯
 FAIL  tests/dataLoaders/gameDataLoader.test.ts > gameDataLoader > Build game objects and returns correct JSON, with optional
AssertionError: expected { 'player:1': { …(5) }, …(1) } to deeply equal { 'player:1': { …(4) }, …(1) }
- Expected
+ Received
@@ -5,9 +5,10 @@
      "type": "majorCultureType:viking",
    },
    "player:1": {
      "cultureKey": "culture:1",
      "isCurrent": true,
+     "isMinor": false,
      "key": "player:1",
      "name": "test player",
    },
  }
 ❯ tests/dataLoaders/gameDataLoader.test.ts:205:53
    203|     const gameObjects = loader.initFromRaw({ objects: [playerData, cul…
    204|
    205|     expect(JSON.parse(JSON.stringify(gameObjects))).toEqual({
       |                                                     ^
    206|       "player:1": playerData,
    207|       "culture:1": cultureData,
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/17]⎯
 FAIL  tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts > pointsInRing > K2 output
 FAIL  tests/factories/TerrainMeshBuilder/hexTrianglesFromPoints.test.ts > pointsInRing > K2 output
 FAIL  tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts > pointsInRing > K2 output
AssertionError: expected [ { x: +0, z: 1, …(2) }, …(11) ] to deeply equal [ { x: +0, z: 1, …(2) }, …(11) ]
- Expected
+ Received
@@ -16,11 +16,11 @@
      "ringNumFromCenter": 2,
      "x": -0.866,
      "z": 0.5,
    },
    {
-     "edge": "sw",
+     "edge": "w",
      "ringNumFromCenter": 2,
      "x": -0.866,
      "z": 0,
    },
    {
@@ -28,11 +28,11 @@
      "ringNumFromCenter": 2,
      "x": -0.866,
      "z": -0.5,
    },
    {
-     "edge": "s",
+     "edge": "sw",
      "ringNumFromCenter": 2,
      "x": -0.433,
      "z": -0.75,
    },
    {
@@ -52,11 +52,11 @@
      "ringNumFromCenter": 2,
      "x": 0.866,
      "z": -0.5,
    },
    {
-     "edge": "ne",
+     "edge": "e",
      "ringNumFromCenter": 2,
      "x": 0.866,
      "z": 0,
    },
    {
@@ -64,11 +64,11 @@
      "ringNumFromCenter": 2,
      "x": 0.866,
      "z": 0.5,
    },
    {
-     "edge": "n",
+     "edge": "ne",
      "ringNumFromCenter": 2,
      "x": 0.433,
      "z": 0.75,
    },
  ]
 ❯ expectFloatsToBeClose tests/_setup/testHelpers.ts:5:42
      3|
      4| export const expectFloatsToBeClose = (expected: object, toBe: object) …
      5|   return expect(crawlForFloat(expected)).toEqual(crawlForFloat(toBe));
       |                                          ^
      6|
      7|   function crawlForFloat(crawlIn: any): any {
 ❯ tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts:14:5
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/17]⎯
 FAIL  tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts > pointsInRing > K3 output
 FAIL  tests/factories/TerrainMeshBuilder/hexTrianglesFromPoints.test.ts > pointsInRing > K3 output
 FAIL  tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts > pointsInRing > K3 output
AssertionError: expected [ { x: +0, z: 0.667, …(2) }, …(11) ] to deeply equal [ { x: +0, z: 0.667, …(2) }, …(11) ]
- Expected
+ Received
@@ -16,11 +16,11 @@
      "ringNumFromCenter": 2,
      "x": -0.577,
      "z": 0.333,
    },
    {
-     "edge": "sw",
+     "edge": "w",
      "ringNumFromCenter": 2,
      "x": -0.577,
      "z": 0,
    },
    {
@@ -28,11 +28,11 @@
      "ringNumFromCenter": 2,
      "x": -0.577,
      "z": -0.333,
    },
    {
-     "edge": "s",
+     "edge": "sw",
      "ringNumFromCenter": 2,
      "x": -0.289,
      "z": -0.5,
    },
    {
@@ -52,11 +52,11 @@
      "ringNumFromCenter": 2,
      "x": 0.577,
      "z": -0.333,
    },
    {
-     "edge": "ne",
+     "edge": "e",
      "ringNumFromCenter": 2,
      "x": 0.577,
      "z": 0,
    },
    {
@@ -64,11 +64,11 @@
      "ringNumFromCenter": 2,
      "x": 0.577,
      "z": 0.333,
    },
    {
-     "edge": "n",
+     "edge": "ne",
      "ringNumFromCenter": 2,
      "x": 0.289,
      "z": 0.5,
    },
  ]
 ❯ expectFloatsToBeClose tests/_setup/testHelpers.ts:5:42
      3|
      4| export const expectFloatsToBeClose = (expected: object, toBe: object) …
      5|   return expect(crawlForFloat(expected)).toEqual(crawlForFloat(toBe));
       |                                          ^
      6|
      7|   function crawlForFloat(crawlIn: any): any {
 ❯ tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts:20:5
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/17]⎯
 FAIL  tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts > pointsInRing > K4 output
 FAIL  tests/factories/TerrainMeshBuilder/hexTrianglesFromPoints.test.ts > pointsInRing > K4 output
 FAIL  tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts > pointsInRing > K4 output
AssertionError: expected [ { x: +0, z: 0.5, …(2) }, …(11) ] to deeply equal [ { x: +0, z: 0.5, …(2) }, …(11) ]
- Expected
+ Received
@@ -16,11 +16,11 @@
      "ringNumFromCenter": 2,
      "x": -0.433,
      "z": 0.25,
    },
    {
-     "edge": "sw",
+     "edge": "w",
      "ringNumFromCenter": 2,
      "x": -0.433,
      "z": 0,
    },
    {
@@ -28,11 +28,11 @@
      "ringNumFromCenter": 2,
      "x": -0.433,
      "z": -0.25,
    },
    {
-     "edge": "s",
+     "edge": "sw",
      "ringNumFromCenter": 2,
      "x": -0.217,
      "z": -0.375,
    },
    {
@@ -52,11 +52,11 @@
      "ringNumFromCenter": 2,
      "x": 0.433,
      "z": -0.25,
    },
    {
-     "edge": "ne",
+     "edge": "e",
      "ringNumFromCenter": 2,
      "x": 0.433,
      "z": 0,
    },
    {
@@ -64,11 +64,11 @@
      "ringNumFromCenter": 2,
      "x": 0.433,
      "z": 0.25,
    },
    {
-     "edge": "n",
+     "edge": "ne",
      "ringNumFromCenter": 2,
      "x": 0.217,
      "z": 0.375,
    },
  ]
 ❯ expectFloatsToBeClose tests/_setup/testHelpers.ts:5:42
      3|
      4| export const expectFloatsToBeClose = (expected: object, toBe: object) …
      5|   return expect(crawlForFloat(expected)).toEqual(crawlForFloat(toBe));
       |                                          ^
      6|
      7|   function crawlForFloat(crawlIn: any): any {
 ❯ tests/factories/TerrainMeshBuilder/pointsInHexRing.test.ts:27:5
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/17]⎯
 FAIL  tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts > buildHexGpuBuffer > writes vertex data in point order and flattens RGBA/XYZ correctly (K1)
AssertionError: expected [ Array(21) ] to deeply equal [ +0, 10, +0, +0, 11, -1, …(15) ]
- Expected
+ Received
  [
    0,
-   10,
+   10.00405741783178,
    0,
    0,
-   11,
+   10.990143492794193,
    -1,
    -0.8660254037844386,
-   12,
+   11.990621833110223,
    -0.5,
    -0.8660254037844386,
-   13,
+   13.004958605108403,
    0.5,
    0,
-   14,
+   14.00853648027208,
    1,
    0.8660254037844386,
-   15,
+   14.992379201168953,
    0.5,
    0.8660254037844386,
-   16,
+   15.995063680893534,
    -0.5,
  ]
 ❯ tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts:14:27
     12|     buildHexGpuBuffer(centerA, points, trisK1Small, getColor, getHeigh…
     13|
     14|     expect(buf.positions).toEqual(expK1PositionsFromCenterA);
       |                           ^
     15|     expect(buf.colors).toEqual(expK1Colors);
     16|     expect(buf.indices).toEqual(trisK1Small);
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/17]⎯
 FAIL  tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts > buildHexGpuBuffer > applies center offset (x,z) and inverts Z
AssertionError: expected [ 10, 10.003042145155211, -7 ] to deeply equal [ 10, 10, -7 ]
- Expected
+ Received
  [
    10,
-   10,
+   10.003042145155211,
    -7,
  ]
 ❯ tests/factories/TerrainMeshBuilder/buildHexGpuBuffer.test.ts:29:39
     27|
     28|     // center
     29|     expect(buf.positions.slice(0, 3)).toEqual([centerB.x + 0, heightMa…
       |                                       ^
     30|     // N corner (z=+1 → centerB.z - 1)
     31|     expect(buf.positions.slice(3, 6)).toEqual([centerB.x + 0, heightMa…
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/17]⎯
 FAIL  tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts > spreadSalt > marks all contiguous water tiles as salt
TypeError: Cannot read properties of undefined (reading 'id')
 ❯ waterCheck src/factories/TerraGenerator/helpers/post-processors.ts:178:47
    176| export const spreadSalt = (gen: TerraGenerator, start: GenTile): void …
    177|   const seen = new Set<string>();
    178|   const waterCheck = (t: GenTile) => t.domain.id === "water";
       |                                               ^
    179|   const visited = crawlTiles(gen, "game", start, seen, waterCheck);
    180|   for (const t of visited) {
 ❯ crawlTiles src/factories/TerraGenerator/helpers/post-processors.ts:138:18
 ❯ spreadSalt src/factories/TerraGenerator/helpers/post-processors.ts:179:19
 ❯ tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts:43:5
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/17]⎯
 FAIL  tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts > spreadSalt > finds its way through a 5x5 'spiral maze' of water tiles
TypeError: Cannot read properties of undefined (reading 'id')
 ❯ waterCheck src/factories/TerraGenerator/helpers/post-processors.ts:178:47
    176| export const spreadSalt = (gen: TerraGenerator, start: GenTile): void …
    177|   const seen = new Set<string>();
    178|   const waterCheck = (t: GenTile) => t.domain.id === "water";
       |                                               ^
    179|   const visited = crawlTiles(gen, "game", start, seen, waterCheck);
    180|   for (const t of visited) {
 ❯ crawlTiles src/factories/TerraGenerator/helpers/post-processors.ts:138:18
 ❯ spreadSalt src/factories/TerraGenerator/helpers/post-processors.ts:179:19
 ❯ tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts:111:5
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/17]⎯
 FAIL  tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts > spreadSalt > does not salt isolated water surrounded by land (3-ring 5x5)
TypeError: Cannot read properties of undefined (reading 'id')
 ❯ waterCheck src/factories/TerraGenerator/helpers/post-processors.ts:178:47
    176| export const spreadSalt = (gen: TerraGenerator, start: GenTile): void …
    177|   const seen = new Set<string>();
    178|   const waterCheck = (t: GenTile) => t.domain.id === "water";
       |                                               ^
    179|   const visited = crawlTiles(gen, "game", start, seen, waterCheck);
    180|   for (const t of visited) {
 ❯ crawlTiles src/factories/TerraGenerator/helpers/post-processors.ts:138:18
 ❯ spreadSalt src/factories/TerraGenerator/helpers/post-processors.ts:179:19
 ❯ tests/factories/TerraGenerator/helpers/post-processors/spreadSalt.test.ts:140:5
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/17]⎯
 Test Files  5 failed | 7 passed (12)
      Tests  17 failed | 40 passed (57)
   Start at  09:21:58
   Duration  1.36s (transform 842ms, setup 0ms, import 3.03s, tests 450ms, environment 3ms)